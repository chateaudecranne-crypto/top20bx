<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top 20 AOC Bordeaux – Prototype</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #0b0f14; --card: #121822; --muted: #9fb3c8; --accent: #38bdf8; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: #e6edf3; }
    a { color: var(--accent); }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.06) }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-20 border-b border-white/10 bg-[#0b0f14]/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-sky-400"><path d="M12 2a1 1 0 0 1 .894.553l2.382 4.764 5.259.764a1 1 0 0 1 .554 1.705l-3.8 3.704.897 5.231a1 1 0 0 1-1.451 1.054L12 17.77l-4.685 2.465a1 1 0 0 1-1.451-1.054l.897-5.23-3.8-3.705a1 1 0 0 1 .554-1.706l5.26-.764L11.106 2.553A1 1 0 0 1 12 2Z"/></svg>
        <h1 class="text-xl font-bold">Top 20 AOC Bordeaux – Prototype</h1>
      </div>
      <div class="text-sm text-white/70">
        Source unique : <span class="font-semibold">Vivino</span> · MAJ prévue : <span id="majLabel">Trimestrielle</span>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Intro / Controls -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="glass rounded-2xl p-5">
        <h2 class="text-lg font-semibold mb-2">Classements par AOC</h2>
        <p class="text-sm text-white/70">Sélectionnez une AOC pour afficher le Top 20, calculé à partir des notes Vivino et pondéré par le volume d'avis.</p>
        <div class="mt-4 flex flex-wrap items-center gap-3">
          <label for="aoc" class="text-sm text-white/70">AOC :</label>
          <select id="aoc" class="bg-[#0f1622] border border-white/10 rounded-xl px-3 py-2 text-sm">
          </select>
          <button id="btnMethodo" class="ml-auto text-sm px-3 py-2 rounded-xl border border-white/10 hover:border-white/20">Méthodologie</button>
        </div>
        <div class="mt-3 text-xs text-white/60" id="lastUpdated"></div>
      </div>
      <div class="glass rounded-2xl p-5">
        <h3 class="text-lg font-semibold mb-2">Résumé automatique</h3>
        <p id="aiSummary" class="text-sm text-white/80">Ce module générera un court résumé (mouvements, entrées/sorties) à chaque mise à jour trimestrielle.</p>
      </div>
    </section>

    <!-- Table -->
    <section class="glass rounded-2xl overflow-hidden">
      <div class="p-4 flex items-center gap-3 border-b border-white/10">
        <input id="search" type="search" placeholder="Rechercher un vin ou producteur…" class="flex-1 bg-[#0f1622] border border-white/10 rounded-xl px-3 py-2 text-sm" />
        <select id="sort" class="bg-[#0f1622] border border-white/10 rounded-xl px-3 py-2 text-sm">
          <option value="rank">Tri : Classement</option>
          <option value="score">Tri : Score pondéré</option>
          <option value="rating">Tri : Note Vivino</option>
          <option value="reviews">Tri : Nombre d'avis</option>
          <option value="price">Tri : Prix estimé</option>
        </select>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-white/5">
            <tr>
              <th class="text-left px-4 py-3 font-semibold">#</th>
              <th class="text-left px-4 py-3 font-semibold">Vin</th>
              <th class="text-left px-4 py-3 font-semibold">Producteur</th>
              <th class="text-left px-4 py-3 font-semibold">Note</th>
              <th class="text-left px-4 py-3 font-semibold">Avis</th>
              <th class="text-left px-4 py-3 font-semibold">Score*</th>
              <th class="text-left px-4 py-3 font-semibold">Prix (€)</th>
              <th class="text-left px-4 py-3 font-semibold">Lien</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="p-4 text-xs text-white/60 border-t border-white/10">* Score pondéré = Note × log10(10 + Avis) (anti-biais faible n)</div>
    </section>

    <!-- Footer -->
    <footer class="mt-8 text-xs text-white/50">
      <p>Prototype local sans collecte automatique. Remplacez les données internes par vos exports Vivino. Hébergeable tel quel (GitHub Pages, Netlify, etc.).</p>
    </footer>
  </main>

  <!-- Modale Méthodo -->
  <dialog id="methodo" class="rounded-2xl glass p-0 w-full max-w-lg">
    <div class="p-5 border-b border-white/10 flex items-start gap-3">
      <div class="shrink-0 mt-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 text-sky-400"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm1 14h-2v-2h2v2Zm0-4h-2V6h2v6Z"/></svg></div>
      <div>
        <h3 class="text-lg font-semibold">Méthodologie (prototype)</h3>
        <p class="text-sm text-white/70 mt-2">Classement calculé à partir des <strong>notes Vivino</strong> et <strong>nombre d'avis</strong>. Score = <code>note × log10(10 + avis)</code>. Tri descendant sur le score, top 20 conservé par AOC.
        <br/>Mise à jour trimestrielle prévue (manuelle dans ce prototype).</p>
      </div>
    </div>
    <div class="p-4 flex justify-end gap-2">
      <button id="closeMethodo" class="px-3 py-2 text-sm rounded-xl border border-white/10">Fermer</button>
    </div>
  </dialog>

  <script>
    // === Données d'exemple (à remplacer par vos données Vivino) ===
    // Pour aller vite : dupliquez un bloc AOC et collez vos 20 entrées {wine, producer, rating, reviews, price, url}
    const RAW = {
      "Saint-Émilion Grand Cru": [
        { wine: "Château Exemplar 2019", producer: "Domaine Exemple", rating: 4.4, reviews: 1280, price: 45, url: "https://www.vivino.com" },
        { wine: "Clos Démo 2020", producer: "Clos Démo", rating: 4.3, reviews: 950, price: 39, url: "https://www.vivino.com" },
        { wine: "Grand Cru Prototype 2018", producer: "Château Prototype", rating: 4.5, reviews: 310, price: 59, url: "https://www.vivino.com" }
      ],
      "Médoc": [
        { wine: "Château Alpha 2018", producer: "Château Alpha", rating: 4.1, reviews: 2100, price: 22, url: "https://www.vivino.com" },
        { wine: "Château Beta 2019", producer: "Château Beta", rating: 4.0, reviews: 430, price: 18, url: "https://www.vivino.com" },
        { wine: "Cuvée Gamma 2020", producer: "Maison Gamma", rating: 4.2, reviews: 380, price: 25, url: "https://www.vivino.com" }
      ],
      "Pessac-Léognan": [
        { wine: "Domaine Delta 2021", producer: "Domaine Delta", rating: 4.3, reviews: 520, price: 32, url: "https://www.vivino.com" },
        { wine: "Château Epsilon 2017", producer: "Château Epsilon", rating: 4.4, reviews: 240, price: 65, url: "https://www.vivino.com" },
        { wine: "Clos Zeta 2019", producer: "Clos Zeta", rating: 4.1, reviews: 900, price: 28, url: "https://www.vivino.com" }
      ]
    };

    // === Utilitaires ===
    const fmt = new Intl.NumberFormat('fr-FR');
    function weightedScore(rating, reviews){
      return +(rating * Math.log10(10 + (reviews||0))).toFixed(3);
    }
    function rankAOC(list){
      return [...list]
        .map(item => ({...item, score: weightedScore(item.rating, item.reviews)}))
        .sort((a,b) => b.score - a.score)
        .slice(0, 20)
        .map((item, idx) => ({ rank: idx+1, ...item }));
    }

    // === État ===
    const state = { aoc: null, search: "", sort: "rank", ranked: {} };

    function init(){
      // Pré-calcul des tops
      for(const [aoc, list] of Object.entries(RAW)){
        state.ranked[aoc] = rankAOC(list);
      }
      // Remplir le select AOC
      const sel = document.getElementById('aoc');
      Object.keys(state.ranked).sort().forEach((aoc, i) => {
        const opt = document.createElement('option');
        opt.value = aoc; opt.textContent = aoc; sel.appendChild(opt);
        if(i===0) state.aoc = aoc;
      });
      sel.value = state.aoc;
      document.getElementById('lastUpdated').textContent = `Dernière mise à jour: ${new Date().toLocaleDateString('fr-FR')}`;
      render();

      // Listeners
      sel.addEventListener('change', e => { state.aoc = e.target.value; render(); });
      document.getElementById('search').addEventListener('input', e => { state.search = e.target.value.toLowerCase(); render(); });
      document.getElementById('sort').addEventListener('change', e => { state.sort = e.target.value; render(); });

      const dlg = document.getElementById('methodo');
      document.getElementById('btnMethodo').addEventListener('click', ()=> dlg.showModal());
      document.getElementById('closeMethodo').addEventListener('click', ()=> dlg.close());

      // Résumé automatique (placeholder simple)
      updateSummary();
    }

    function updateSummary(){
      const aoc = state.aoc; const top = state.ranked[aoc] || [];
      const leader = top[0];
      const fastRiser = top[1];
      const t = leader ? `\nDans l'AOC ${aoc}, ${leader.wine} (${leader.producer}) domine avec une note ${leader.rating} basée sur ${fmt.format(leader.reviews)} avis. ` : '';
      const r = fastRiser ? `Un challenger notable: ${fastRiser.wine}, porté par une forte popularité.` : '';
      document.getElementById('aiSummary').textContent = (t + r).trim() || "Sélectionnez une AOC pour afficher un résumé.";
    }

    function render(){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      let rows = [...(state.ranked[state.aoc] || [])];

      // Filtre recherche
      if(state.search){
        rows = rows.filter(r =>
          r.wine.toLowerCase().includes(state.search) ||
          (r.producer||'').toLowerCase().includes(state.search)
        );
      }
      // Tri
      const sort = state.sort;
      const keyer = {
        rank: r => r.rank,
        score: r => r.score,
        rating: r => r.rating,
        reviews: r => r.reviews || 0,
        price: r => r.price ?? Infinity
      }[sort];
      const dir = sort === 'rank' ? 1 : -1; // rank asc, others desc
      rows.sort((a,b)=> dir * (keyer(a) - keyer(b)));

      // Render
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap">${r.rank}</td>
          <td class="px-4 py-3">${r.wine}</td>
          <td class="px-4 py-3">${r.producer||''}</td>
          <td class="px-4 py-3">${r.rating?.toFixed(2)}</td>
          <td class="px-4 py-3">${fmt.format(r.reviews||0)}</td>
          <td class="px-4 py-3">${r.score?.toFixed(3)}</td>
          <td class="px-4 py-3">${r.price!=null ? fmt.format(r.price) : '—'}</td>
          <td class="px-4 py-3"><a href="${r.url||'#'}" target="_blank" rel="noopener">Vivino</a></td>
        `;
        tbody.appendChild(tr);
      }
      updateSummary();
    }

    // === Import rapide depuis CSV (optionnel) ===
    // Format attendu: wine,producer,rating,reviews,price,url (sans en-tête)
    // Collez dans la console: injectCSV(`AOC NAME`, `ligne1\nligne2...`)
    window.injectCSV = function(aocName, csv){
      const lines = csv.trim().split(/\r?\n/);
      const list = lines.map(l=>{
        const [wine, producer, rating, reviews, price, url] = l.split(',');
        return { wine: wine?.trim(), producer: (producer||'').trim(), rating: +rating, reviews: +reviews, price: price? +price : undefined, url: (url||'').trim() };
      });
      RAW[aocName] = list;
      state.ranked[aocName] = rankAOC(list);
      if(!Object.keys(state.ranked).includes(state.aoc)) state.aoc = aocName;
      const sel = document.getElementById('aoc');
      sel.innerHTML = '';
      Object.keys(state.ranked).sort().forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a; sel.appendChild(o); });
      sel.value = aocName;
      render();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
